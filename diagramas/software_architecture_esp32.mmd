flowchart TD
    subgraph ESP32_SW ["ğŸ›ï¸ SOFTWARE ESP32"]
        subgraph TASKS ["ğŸ”„ TAREAS PRINCIPALES"]
            TASK_SENSOR["ğŸ“Š Tarea Sensores<br/>â€¢ Leer voltaje/corriente<br/>â€¢ Cada 10ms"]
            TASK_CONTROL["ğŸ›¡ï¸ Tarea Control<br/>â€¢ Calcular potencia<br/>â€¢ Detectar sobrecarga"]
            TASK_DISPLAY["ğŸ“± Tarea Display<br/>â€¢ Actualizar LCD<br/>â€¢ Controlar LEDs/Buzzer"]
            TASK_WIFI["ğŸ“¡ Tarea WiFi<br/>â€¢ Enviar datos<br/>â€¢ Conectar internet"]
        end
        
        subgraph FUNCTIONS ["âš™ï¸ FUNCIONES BÃSICAS"]
            FUNC_MEASURE["ğŸ“ Medir<br/>V, I, P"]
            FUNC_PROTECT["ğŸ›¡ï¸ Proteger<br/>Sobrecarga"]
            FUNC_SHOW["ğŸ“º Mostrar<br/>Datos"]
            FUNC_SEND["ğŸ“¤ Enviar<br/>WiFi"]
        end
        
        FREERTOS["ğŸ”„ FreeRTOS<br/>Sistema Operativo"]
    end
    
    subgraph DATA_FLOW ["ğŸ“Š FLUJO DE DATOS"]
        SENSORS_DATA["ğŸ“Š Datos Sensores"]
        POWER_DATA["âš¡ Datos Potencia"]
        DISPLAY_DATA["ğŸ“º Datos Display"]
        WIFI_DATA["ğŸ“¡ Datos WiFi"]
    end
    
    %% Flujo principal
    TASK_SENSOR --> SENSORS_DATA
    SENSORS_DATA --> TASK_CONTROL
    TASK_CONTROL --> POWER_DATA
    POWER_DATA --> TASK_DISPLAY
    POWER_DATA --> TASK_WIFI
    TASK_DISPLAY --> DISPLAY_DATA
    TASK_WIFI --> WIFI_DATA
    
    %% ConexiÃ³n con funciones
    TASK_SENSOR --> FUNC_MEASURE
    TASK_CONTROL --> FUNC_PROTECT
    TASK_DISPLAY --> FUNC_SHOW
    TASK_WIFI --> FUNC_SEND
    
    %% Base del sistema
    TASKS --> FREERTOS
    FUNCTIONS --> FREERTOS
    
    %% Timing crÃ­tico
    TASK_SENSOR -.->|"10ms"| TASK_CONTROL
    TASK_CONTROL -.->|"<100ms"| TASK_DISPLAY
    
    %% Estilos
    classDef task fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef function fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef data fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef os fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef critical stroke:#d32f2f,stroke-width:3px
    
    class TASK_SENSOR,TASK_CONTROL,TASK_DISPLAY,TASK_WIFI task
    class FUNC_MEASURE,FUNC_PROTECT,FUNC_SHOW,FUNC_SEND function
    class SENSORS_DATA,POWER_DATA,DISPLAY_DATA,WIFI_DATA data
    class FREERTOS os
    class TASK_SENSOR,TASK_CONTROL critical